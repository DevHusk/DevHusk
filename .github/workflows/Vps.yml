name: Persistent Tmate VPS Session

on:
  # Manual trigger for initial start
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Start Tmate Session (Use for initial run)'
        required: false
        default: true
  
  # CRON schedule: Runs every 6 hours (360 minutes) to keep the "VPS" running
  schedule:
    - cron: '0 */6 * * *' 
    
jobs:
  tmate_session:
    runs-on: ubuntu-latest
    
    # MAXIMUM JOB RUNTIME: 360 minutes (6 hours)
    timeout-minutes: 360 
    
    steps:
      - name: ‚öôÔ∏è Checkout Repository
        uses: actions/checkout@v4
        
      # --- Data Persistence: RESTORE ---
      
      - name: ‚¨áÔ∏è Download Previous Data Artifact
        uses: actions/download-artifact@v4
        # Allows the job to continue if the artifact doesn't exist (first run)
        continue-on-error: true 
        with:
          name: tmate-vps-data
          # Download to a temporary location
          path: /tmp/data_artifact 
          
      - name: üõ†Ô∏è Restore Previous State
        # Executes the restore script
        run: chmod +x .github/scripts/restore.sh && .github/scripts/restore.sh
      
      # --- Tmate Session (5 hours 40 minutes runtime) ---

      - name: üíª Start Tmate VPS Session
        uses: mxschmitt/action-tmate@v3
        with:
          # Tmate session times out at 340 minutes, creating the 20-minute backup buffer
          timeout-minutes: 340 
          limit-access-to-actor: true

      # --- Data Persistence: BACKUP (Runs in the 20-minute buffer) ---
      
      - name: ‚¨ÜÔ∏è Backup Current State
        # Executes the backup script
        run: chmod +x .github/scripts/backup.sh && .github/scripts/backup.sh
          
      - name: üì¶ Upload Current Data Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tmate-vps-data # Must match the name in the download step
          path: tmate-data-backup.tar.gz
          retention-days: 1 # Keep the artifact for 1 day
          
