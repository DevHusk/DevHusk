name: VPS

on:
  # Manual trigger for initial start
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Start Tmate Session (Use for initial run)'
        required: false
        default: true
  
  # CRON schedule: Runs every 6 hours (360 minutes) to keep the "VPS" running
  schedule:
    - cron: '0 */6 * * *' 
    
jobs:
  tmate_session:
    runs-on: ubuntu-latest
    
    # MAXIMUM JOB RUNTIME: 360 minutes (6 hours)
    timeout-minutes: 360 
    
    steps:
      - name: ⚙️ Checkout Repository
        uses: actions/checkout@v4
        
      # --- Data Persistence: RESTORE ---
      
      - name: ⬇️ Download Previous Data Artifact
        uses: actions/download-artifact@v4
        continue-on-error: true 
        with:
          name: tmate-vps-data
          path: /tmp/data_artifact 
          
      - name: 🛠️ Restore Previous State
        run: chmod +x .github/scripts/restore.sh && .github/scripts/restore.sh
      
      # 🚀 START DETACHED TMATE SESSION 🚀
      # This step will run quickly and print the connection string once.
      - name: 💻 Start Tmate VPS Session (Detached Mode)
        uses: mxschmitt/action-tmate@v3
        id: tmate_session # Added ID for reference
        with:
          # Set detached to true so the workflow moves on immediately
          detached: true 
          # The entire job runs for 360 minutes, so this session can run for 5h 40m
          timeout-minutes: 340 
          limit-access-to-actor: true

      # --- WAITING PERIOD ---
      # This step waits until the 5 hours and 40 minutes have passed,
      # ensuring the backup runs right before the 6-hour job timeout.
      - name: ⏳ Wait for Session Duration (5 hours 40 minutes)
        # We need to wait for the exact duration minus a small buffer for safety
        run: sleep 5h 40m 
        
      # --- Data Persistence: BACKUP ---
      # This step runs after the wait period (at the ~345 minute mark of the job)
      - name: ⬆️ Backup Current State
        # Ensures the tmate session is properly ended before backup
        run: tmate kill-session || true
        # Executes the backup script
        run: chmod +x .github/scripts/backup.sh && .github/scripts/backup.sh
          
      - name: 📦 Upload Current Data Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tmate-vps-data
          path: tmate-data-backup.tar.gz
          retention-days: 1
          
